define(["backbone","jquery","underscore","pages/forum/app","pages/forum/models/ForumCollection","pages/forum/views/ThreadNewView.html","pages/forum/views/EditorUtil","pages/forum/models/ThreadModel","js/lib/select2","js/lib/badgeville"],function(e,u,t,r,a,s,o,n,i,d){var l="BugInPlatform",c="BugInCourseMaterial",h="BugReport",g="technical",f="course material",E=e.View.extend({defaults:{},events:{"submit .course-forum-thread-new-form":"onThreadSave","change input[name=is_bug_report]":"onBugChange","change input[name=is_coursera_bug_report]":"onBugTypeChange","change input[name=is_course_material_report]":"onBugTypeChange","blur input[name=title]":"onTitleChange"},initialize:function(){this.thread=this.model,this.render()},render:function(){var e=this;e.$el.html(s({config:r.config,thread:e.thread})),e.$form=e.$(".course-forum-thread-new-form"),e.$bugCheckbox=e.$('input[name="is_bug_report"]'),e.$techCheckbox=e.$('input[name="is_coursera_bug_report"]'),e.$materialsCheckbox=e.$('input[name="is_course_material_report"]'),e.bugFields=[e.$techCheckbox,e.$materialsCheckbox],e.$tagsInput=e.$('input[name="tags"]'),e.$titleInput=e.$("input[name=title]"),e.$forumsDropdown=e.$(".course-forum-thread-new-subforums"),e.editor=o.makeEditor(e.$form),r.api.get("forum/forums").done(function(r){var s=t.sortBy(r,function(e){return e.name}),o=new a(s);o.each(function(t){var r=u("<option>");r.attr("value",t.id),r.text(t.getFullName()),t.id==e.thread.get("forum_id")&&(r.attr("selected","selected"),e.forum=t),e.$forumsDropdown.append(r)}),e.forums=s,e.setupBugFields()}),r.api.get("forum/tags").done(function(u){var r=t.map(u,function(e){return e.tag_name});e.$tagsInput.select2({tags:r}),e.options.tagName&&e.addTag(e.options.tagName)})},setupBugFields:function(){var e=this;if(e.forum){var u=e.forum.get("name").toLowerCase().indexOf(g)>-1,t=e.forum.get("name").toLowerCase().indexOf(f)>-1;(u||t)&&e.$bugCheckbox.attr("checked","checked"),u&&e.$techCheckbox.attr("checked","checked"),t&&e.$materialsCheckbox.attr("checked","checked"),e.onBugChange(),e.onBugTypeChange()}},onBugChange:function(){var e=this;if(e.$bugCheckbox.is(":checked")){u.each(e.bugFields,function(e,u){u.parents(".control-group").show()});var t=e.$("textarea[name=text]");if(""===t.val()){var r="The problem summary:<br><br>Steps to reproduce:<ol><li></li></ol><br>Screenshot:<br><br>";e.editor.setValue(r)}e.addTag(h)}else u.each(e.bugFields,function(e,u){u.parents(".control-group").hide()}),e.removeTag(h)},updateTags:function(e){var u=this;u.$tagsInput.val(t.uniq(e)),u.$tagsInput.select2("val",t.uniq(e))},addTag:function(e){var u=this,t=[];""!==u.$tagsInput.val()&&(t=u.$tagsInput.val().split(",")),t.push(e),u.updateTags(t)},removeTag:function(e){var u=this,r=[];""!==u.$tagsInput.val()&&(r=u.$tagsInput.val().split(",")),r=t.without(r,e),u.updateTags(r)},onBugTypeChange:function(){var e=this;e.$techCheckbox.is(":checked")?(e.addTag(l),e.$forumsDropdown.find("option").each(function(){u(this).text().toLowerCase().indexOf(g)>-1&&u(this).attr("selected","selected")})):e.removeTag(l),e.$materialsCheckbox.is(":checked")?(e.addTag(c),e.$forumsDropdown.find("option").each(function(){u(this).text().toLowerCase().indexOf(f)>-1&&u(this).attr("selected","selected")})):e.removeTag(c)},onTitleChange:function(){var e=this;e.$titleInput.blur(function(){var t=e.$titleInput.val();if(t){var r="search?autocomplete=json&forum_id="+e.thread.get("forum_id")+"&q="+encodeURI(t);u.get(r,null,function(u){u.length>5&&(e.$(".course-forum-new-suggestions-list").html(u),e.$(".course-forum-new-suggestions").show("slow"))},"html")}})},redirectToThread:function(e){var u=window.location.pathname.substr(0,window.location.pathname.lastIndexOf("/")+1);window.location.href=u+"thread?thread_id="+e},onThreadSave:function(e){function u(e){r.$(".course-forum-thread-new-error").closest(".control-group").addClass("error"),r.$(".course-forum-thread-new-error").html("Error: "+e),r.$form.find("button").attr("disabled",null)}e.preventDefault();var r=this;r.$form.find("button").attr("disabled","disabled");var a=o.getPropsFromForm(r.$form);a.tags=t.map(a.tags.split(","),function(e){return{tag_name:e}}),r.thread.update(a,{message:{waiting:"Creating thread...",success:"Created thread!"}}).done(function(e){e.id?1!=a.anonymous&&d.isEnabled()?d.credit({verb:"created-thread",week:d.getWeek()},function(){r.redirectToThread(e.id)}):r.redirectToThread(e.id):u("Could not create thread.")}).fail(function(e){u(e.responseText)})}});return E});