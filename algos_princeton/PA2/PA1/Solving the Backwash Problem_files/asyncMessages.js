define(["jquery","underscore","js/lib/cookie","backbone"],function(t,e,n,i){var r={defaults:{selector:null},defaults_item:{timeout:0},item_remove:function(t){var n=e.indexOf(this.stack,t.options.id);if(-1!=n){this.stack.splice(n,1);for(var i in t.options.events)t.$ele.off(i+".asyncMessage");t.$ele.remove()}delete this.items[t.options.id]},item_show:function(t){var e=this;if(this.stack.length){var n=this.items[this.stack[0]];n&&n.$ele.remove()}this.$container.append(t.$ele),this.trigger("showing",t.$ele),this.$container.show(),this.stack.unshift(t.options.id),this.trigger("show",t),t.options.timeout&&setTimeout(function(){e.trigger("hiding",t),e.remove(t.options.id),e.trigger("hide",t)},t.options.timeout);for(var i in t.options.events)t.$ele.on(i+".asyncMessage",function(n){t.options.events[i].call(e,n,t)})}},o=function(e,n){this.options=t.extend({},r.defaults,n),this.$ele=t(e||t("<div>").appendTo("body")),this.$container=this.options.selector?this.$ele.find(this.options.selector):this.$ele,this.stack=[],this.items={}};return o.prototype.add=function(n,i){var o=t(n),a=t.extend({},r.defaults_item,i),s=this;if(a.id=a.id||e.uniqueId(),e.has(this.items,a.id))return a.id;this.items[a.id]={$ele:o,options:a,timer:null};var u=function(){s.stack.length||s.trigger("opening"),r.item_show.call(s,s.items[a.id]),1==s.stack.length&&s.trigger("open")};return a.delay?this.items[a.id].timer=setTimeout(u,a.delay):u(),a.id},o.prototype.remove=function(t){var e=this.items[t];if(e)if(clearTimeout(e.timer),1==this.stack.length)this.trigger("closing"),r.item_remove.call(this,e),this.$container.hide(),this.trigger("close");else{if(this.stack.length){var n=this.items[this.stack.shift()];n&&r.item_show.call(this,n)}r.item_remove.call(this,e)}},e.extend(o.prototype,i.Events),{create:function(t,e){return new o(t,e)}}});