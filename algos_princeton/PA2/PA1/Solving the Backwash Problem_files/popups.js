(function(t){var e=function(t,e,u){var o=38,n=40,i=32,r=27,s=1,a=0,l={defaults:{"bind.open":"click","bind.close":"click","bind.cancel.document":"mousemove","bind.cancel.popup":"mouseleave","bind.uncancel.popup":"mouseenter","bind.keydown":"keydown",direction:"sw","offset.x":0,"offset.y":0,timeout:450,"timeout.intent":350,resize:!1,width:!1,"attribute.open":"data-popup","attribute.close":"data-popup-close","attribute.item":"data-popup-item",position:"absolute"},prevPopup:null,prevTimeout:null,timeout:null,timeoutClear:null,getPopup:function(e,u){var o=t(e).data("popup.me");return o&&o.constructor==c.prototype.constructor?u?o.customize(u):o:null},getPopupForAnchor:function(u,o){var n=u.attr(l.defaults["attribute.open"]),i=t(n),r=l.readDataAttributes(u,"data-popup-",e.extend({},l.defaults,o)),s=l.makePopup(i,r);return s},closeOlderPopups:function(){l.prevPopup&&(l.prevPopup.close(),l.prevPopup=null)},isTouch:"ontouchstart"in window||window.DocumentTouch&&document instanceof DocumentTouch,makePopup:function(e,u){var o,n=t(e);return o=n.attr("data-popup")?l.getPopupForAnchor(n):l.getPopup(n),o||(o=new c(n,u),n.data("popup.me",o)),o},monitorKeys:function(t){e.contains([o,n],t.keyCode)&&(t.preventDefault(),t.stopPropagation(),l.changeFocus.call(this,t)),t.keyCode==r&&(this.$anchor.focus(),this.close())},monitorActions:function(e){this.$el[0];var u=t(e.target),o=this;if("mouseleave"!=e.type){if(u.closest(this.$el).size()>0||u.closest(this.$anchor).size()>0)return window.clearTimeout(l.timeout),void 0}else l.timeout=window.setTimeout(function(){o.state==s&&o.close()},this.options.timeout)},readDataAttributes:function(t,e,u){var o={};for(var n in u){var i=t.attr(e+n.replace(/\./g,"-"));o[n]=void 0===i?u[n]:i}return o},intentOpen:function(e,u,o){var n=o[0];e.pageX,e.pageY,l.prevTimeout&&(t(document).off(".popup"),window.clearTimeout(l.prevTimeout)),l.prevTimeout=window.setTimeout(function(){window.clearTimeout(l.prevTimeout),t(document).off(".popup"),u.isOpen()||u.open(o)},u.options["timeout.intent"]),t(document).on("mousemove.popup mouseleave.popup",function(e){("mouseleave"==e.type||e.target!=n&&0===t(e.target).closest(n).size())&&(t(document).off(".popup"),window.clearTimeout(l.prevTimeout))})},changeFocus:function(t){if(this.$anchor){var e=this.$anchor.attr(this.options["attribute.item"]),u=this.$el.children(":visible");e&&(u=u.filter(e)),u.length&&(index=u.index(u.filter(":focus")),t.keyCode==o&&index--,t.keyCode==n&&index++,0>index||index>=u.length?this.$anchor.focus():u.length>index&&u.eq(index).focus())}}},c=function(e,u){this.$el=t(e),this.$parent=this.$el.parent(),this.$anchor=null,this.customize(u)};c.prototype.customize=function(t){return this.options=e.extend({},l.defaults,t),this.options["offset.x"]=parseInt(this.options["offset.x"],10),this.options["offset.y"]=parseInt(this.options["offset.y"],10),this},c.prototype.get=function(){return this.$el},c.prototype.open=function(u){var o=this,n=t(u);if(!this.$anchor||this.$anchor[0]!=n[0]){var i=n.position();this.$anchor=n,this.$anchor.parent().append(this.$el),this.$anchor.attr("aria-expanded","true"),o.options.resize&&this.$el.width(this.$anchor.outerWidth()),o.options.width&&this.$el.css("width",o.options.width),this.trigger("opening",this.$anchor),this.options.direction&&"sw"!=this.options.direction?"se"==this.options.direction?this.move(i.left+n.outerWidth()+this.options["offset.x"]-this.$el.outerWidth(),i.top+n.outerHeight()+this.options["offset.y"]):"ne"==this.options.direction?this.move(i.left+n.outerWidth()+this.options["offset.x"]-this.$el.outerWidth(),i.top-this.$el.outerHeight()):"s"==this.options.direction?this.move(i.left+n.outerWidth()/2+this.options["offset.x"]-this.$el.outerWidth()/2,i.top+n.outerHeight()+this.options["offset.y"]):"w"==this.options.direction&&this.move(i.left+this.options["offset.x"]-this.$el.outerWidth(),i.top+this.options["offset.y"]):this.move(i.left+this.options["offset.x"],i.top+n.outerHeight()+this.options["offset.y"]),this.$el.show(),window.setTimeout(function(){l.closeOlderPopups(),n.addClass("popup-opened").focus(),o.trigger("opened",o.$anchor),o.state=s,l.prevPopup=o,o.$el.on(o.options["bind.cancel.popup"]+".popup",e.bind(l.monitorActions,o)),o.$anchor.on(o.options["bind.cancel.popup"]+".popup",e.bind(l.monitorActions,o)),o.$el.on(o.options["bind.uncancel.popup"]+".popup",e.bind(l.monitorActions,o)),o.$anchor.on(o.options["bind.uncancel.popup"]+".popup",e.bind(l.monitorActions,o)),t(document).on(o.options["bind.cancel.document"]+".popup",e.bind(l.monitorActions,o)).on(o.options["bind.keydown"]+".popup",e.bind(l.monitorKeys,o)),o.options["attribute.close"]&&o.$el.on(o.options["bind.close"]+".popup","["+o.options["attribute.close"]+"]",function(e){"disabled"!=t(e.currentTarget).attr("disabled")&&o.close()})},0)}return this},c.prototype.move=function(t,e,u){return this.$el.css({left:t,top:e,"z-index":u||1e4,position:this.options.position}),this},c.prototype.close=function(){return t(document).off(".popup"),this.$anchor.attr("aria-expanded","false"),this.$anchor.removeClass("popup-opened"),this.trigger("closing",this.$anchor),this.$el.off(".popup").hide(),this.$anchor.off(".popup"),this.$parent.append(this.$el),this.trigger("closed",this.$anchor),this.$anchor=null,this.state=a,window.clearTimeout(this.timeout),l.prevPopup=null,this},c.prototype.isOpen=function(){return this.$el.is(":visible")},e.extend(c.prototype,u.Events);var p=function(){return l.getPopup.apply(null,arguments)||l.makePopup.apply(this,arguments)};return p.start=function(u,r){function s(t,e){t.isOpen()||t.open(e)}var a=t(u),c=e.extend({},l.defaults,r);a.on("click.popup mouseenter.popup keydown.popup","["+c["attribute.open"]+"]",function(u){var a=t(this),c=a.attr("data-popup-bind-open");if("disabled"!=a.attr("disabled")){var p=l.getPopupForAnchor(a,r);"keydown"==u.type&&e.contains([o,n,i],u.keyCode)&&(u.preventDefault(),u.stopPropagation(),u.keyCode==n||u.keyCode==i?(p.isOpen()||s(p,a),l.changeFocus.call(p,u)):u.keyCode==o&&p.isOpen()&&p.close()),(u.type==c||!c&&"click"==u.type||l.isTouch&&"click"==u.type)&&("mouseover"==u.type||"mouseenter"==u.type?l.intentOpen(u,p,a):s(p,a))}})},p.stop=function(e){var u=t(e);u.off(".popup"),l.closeOlderPopups()},p.start("body"),p};"function"==typeof define&&define.amd?define(["jquery","underscore","backbone"],function(t,u,o){return e(t,u,o)}):t.Popup=e(t.$,t._,t.Backbone)})(window);