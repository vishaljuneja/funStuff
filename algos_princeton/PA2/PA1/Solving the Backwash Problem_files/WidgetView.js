define(["backbone","jquery","underscore","js/lib/util","js/lib/jquery.bbq"],function(e,t,r){var s="-state-",i=e.View.extend({getWidgetId:function(){return this.widgetId=this.widgetId||this.options.widgetId||r.uniqueId(),this.widgetId},getWidgetKey:function(e){return this.getWidgetId()+s+e},addWidgetStateListener:function(){function e(e){if(e.indexOf("#")>-1){var i=t.deparam(e.split("#")[1]);return r.each(i,function(e,t){-1==t.indexOf(o.getWidgetId()+s)&&delete i[t]}),i}return{}}var i,o=this,a=window.location.href;t(window).bind("hashchange",function(){i=window.location.href;var t=e(a),n=e(i),h=[];r.each(n,function(e,r){t[r]&&t[r]!==e&&h.push(r)}),h=r.union(h,r.difference(r.keys(n),r.keys(t))),h=r.map(h,function(e){return e.split(s)[1]}),o.trigger("widget:changed",h),a=window.location.href})},getWidgetState:function(e){return t.bbq.getState(this.getWidgetKey(e))},changeWidgetState:function(e){var s=this,i={};r.each(e,function(e,t){i[s.getWidgetKey(t)]=e}),t.bbq.pushState(i)}});return i});