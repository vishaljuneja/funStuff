define(["backbone","jquery","underscore","js/lib/util","js/lib/cookie","pages/forum/app","pages/forum/views/ThreadView.html","pages/forum/views/ThreadSortView.html","pages/forum/views/ForumCrumbsView.html","pages/forum/views/ThreadHeaderView","pages/forum/views/ThreadTagsView","pages/forum/views/PostContainerView","pages/forum/models/ThreadModel","pages/forum/models/PostModel","js/lib/badgeville"],function(e,t,o,r,n,i,s,u,a,c,l,p,d,g,h){var f=o.throttle(function(e){e.model.getPostsBefore()},1500),m=o.throttle(function(e){e.model.getPostsAfter()},1500),b=function(e){e.position()&&t("html,body").scrollTop(e.position().top)},v="Forum Thread",E=e.View.extend({defaults:{},events:{"click .course-forum-thread-admin-details-link":"onAdminDetailsClick"},initialize:function(){this.hangoutsEnabled=o.isUndefined(this.options.hangoutsEnabled)?!1:this.options.hangoutsEnabled,this.thread=this.model,this.thread.bind("change",this.render,this),this.thread.bind("error",this.renderError,this),this.thread.read({data:{post_id:this.options.post,comment_id:this.options.comment,sort:this.thread.get("_sort_order")},message:{waiting:"Fetching thread information..."}},o.bind(this.thread.onFetchPosts,this.thread,null)),this.postContainers={},t(window).on("scroll",o.bind(this.onScroll,this))},renderError:function(e,o){this.$(".course-forum-thread-error").remove();var r=t("<div>");r.append(o.responseText).addClass("alert alert-error course-forum-thread-error"),this.$el.append(r)},updatePageMeta:function(){"page"==this.options.mode&&(document.title=this.thread.get("title"),r.setMetaTag("property","og:title",this.thread.get("title")),r.setMetaTag("property","og:url",this.thread.get("link")))},render:function(){var e=this,t=e.thread.changedAttributes();if(e.updatePageMeta(),e.$(".course-forum-thread-posts-container").length||(e.$el.html(s({config:i.config,thread:e.thread})),e.$(".course-forum-thread-crumbs").html(a({_:o,crumbs:this.thread.get("crumbs")})),e.$(".course-forum-thread-tags").html(new l({model:this.thread}).render().el),e.$(".course-forum-thread-header-wrapper").html(new c({model:this.thread}).render().el),this.thread.getTriageStatus(),this.thread.get("user_id")!=i.user.get("id")&&window.setTimeout(function(){h.credit({verb:"viewed",thread:e.thread.get("id")})},7e3)),e.$(".course-forum-thread-posts-container").is(":empty")||t&&o.intersection(o.keys(t),["locked","start_range","end_range","num_posts"]).length>0){e.$(".course-forum-thread-sort").html(u({user:i.user,thread:this.thread}));var r=null;e.$(".course-forum-thread-sort ul li").each(function(t,o){var n=e.$(o);n.attr("data-sort-name")===e.thread.get("sort")&&(n.addClass("active"),r=n)}),r||e.$(".course-forum-thread-sort ul li").eq(1).addClass("active"),e.renderPosts(),e.scrollToPermalinkMaybe(),e.maybeShowHangoutPopup()}return 1==e.thread.get("deleted")?e.$el.addClass("course-forum-thread-deleted"):e.$el.removeClass("course-forum-thread-deleted"),1==e.thread.get("locked")?(e.$(".course-forum-thread-new-post").hide(),e.$(".course-forum-new-comment-link-container").hide()):(e.$(".course-forum-thread-new-post").show(),e.$(".course-forum-new-comment-link-container").show()),e},saveNewPostMaybe:function(){var e=this;this.newPost.isNew()||(this.model.get("posts").add(this.newPost),this.initNewPost(),e.renderPosts())},scrollToPermalinkMaybe:function(){var e=this;if(!e.hasScrolled){e.hasScrolled=!0;var t,o=this.options.post,r=this.options.comment;o?t=e.$('[data-permalink="post-'+o+'"]'):r&&(t=e.$('[data-permalink="comment-'+r+'"]')),t&&(t.addClass("course-forum-permalink"),b(t),e.thread.getPostsBefore(function(){b(t)}))}},initNewPost:function(){var e=this;this.newPost&&this.newPost.unbind("sync",this.saveNewPostMaybe,this),this.newPost=new g({thread_id:this.thread.get("id"),thread:this.thread}),this.newPost.bind("sync",this.saveNewPostMaybe,this);var t=new p({model:this.newPost,comments:this.thread.getCommentsForPost(this.newPost)});e.$el.find(".course-forum-thread-new-post").html(t.render().$el)},renderPosts:function(){var e=this;e.model.get("posts").each(function(t){if(!o.has(e.postContainers,t.get("id"))&&t.get("post_text")){var r=new p({model:t,thread:e.thread,comments:e.thread.getCommentsForPost(t)}),n=e.thread.get("posts").find(function(o){return o.get("order")>t.get("order")&&e.postContainers[o.get("id")]}),i=o.find(e.thread.get("posts").toArray().reverse(),function(o){return o.get("order")<t.get("order")&&e.postContainers[o.get("id")]});if(n){var s=e.postContainers[n.get("id")];s.$el.before(r.render().$el)}else if(i){var u=e.postContainers[i.get("id")];u.$el.after(r.render().$el)}else e.$el.find(".course-forum-thread-posts-container").append(r.render().$el);e.postContainers[t.get("id")]=r}}),e.thread.get("end_range")===e.thread.get("posts").length&&(e.hideBottomScrollIndicator(),e.initNewPost()),1===e.thread.get("start_range")&&e.$el.find(".course-forum-top-scroll-indicator").hide()},hideBottomScrollIndicator:function(){this.$el.find(".course-forum-bottom-scroll-indicator").hide(),this.$el.find(".course-forum-thread-new-post")},onScroll:function(){var e=this;e.hasScrolled=!0;var o=t(window),r=400;o.scrollTop()+o.height()+r>t(document).height()&&m(e),100>o.scrollTop()&&f(e)},onAdminDetailsClick:function(){this.$(".course-forum-post-admin-container").show(),i.multitracker.push([v,"Admin Details"])},maybeShowHangoutPopup:function(){var e="course.forum.hangouts.disabled",o=this.$(".course-forum-hangouts-popup");this.hangoutsEnabled&&!o.is(":visible")&&window.outerWidth>1200&&this.thread.userContributed(i.user.get("id"))&&this.thread.getTotalVotes()>=2&&this.thread.get("posts").size()+this.thread.get("comments").size()>=3&&!n.get(e)&&(this.$("[data-action=start]").on("click",function(){t(this).next("p").show(),i.multitracker.push([v,"Hangout Popup Start Click"]),t(this).off("click")}),this.$("[data-action=join]").on("click",function(){t(this).next("p").show(),i.multitracker.push([v,"Hangout Popup Join Click"]),t(this).off("click")}),this.$("[data-action=hide]").on("click",function(){o.hide(),i.multitracker.push([v,"Hangout Popup Close Click"]),t(this).off("click")}),this.$("[data-action=nothanks]").on("click",function(){o.hide(),i.multitracker.push([v,"Hangout Popup NoThanks Click"]),n.set(e,"true"),t(this).off("click")}),o.show(),i.multitracker.push([v,"Hangout Popup Show"]))}});return E});