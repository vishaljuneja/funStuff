define(["backbone","underscore"],function(t,e){"use strict";var n=window;t.Relational={showWarnings:!0},t.Semaphore={_permitsAvailable:null,_permitsUsed:0,acquire:function(){if(this._permitsAvailable&&this._permitsUsed>=this._permitsAvailable)throw Error("Max permits acquired");this._permitsUsed++},release:function(){if(0===this._permitsUsed)throw Error("All permits released");this._permitsUsed--},isLocked:function(){return this._permitsUsed>0},setAvailablePermits:function(t){if(this._permitsUsed>t)throw Error("Available permits cannot be less than used permits");this._permitsAvailable=t}},t.BlockingQueue=function(){this._queue=[]},e.extend(t.BlockingQueue.prototype,t.Semaphore,{_queue:null,add:function(t){this.isBlocked()?this._queue.push(t):t()},process:function(){for(;this._queue&&this._queue.length;)this._queue.shift()()},block:function(){this.acquire()},unblock:function(){this.release(),this.isBlocked()||this.process()},isBlocked:function(){return this.isLocked()}}),t.Relational.eventQueue=new t.BlockingQueue,t.Store=function(){this._collections=[],this._reverseRelations=[],this._subModels=[],this._modelScopes=[n]},e.extend(t.Store.prototype,t.Events,{addModelScope:function(t){this._modelScopes.push(t)},addSubModels:function(t,e){this._subModels.push({superModelType:e,subModels:t})},setupSuperModel:function(t){e.find(this._subModels,function(n){return e.find(n.subModels,function(e,r){var i=this.getObjectByName(e);return t===i?(n.superModelType._subModels[r]=t,t._superModel=n.superModelType,t._subModelTypeValue=r,t._subModelTypeAttribute=n.superModelType.prototype.subModelTypeAttribute,!0):void 0},this)},this)},addReverseRelation:function(t){var n=e.any(this._reverseRelations,function(n){return e.all(t,function(t,e){return t===n[e]})});if(!n&&t.model&&t.type){this._reverseRelations.push(t);var r=function(t,n){t.prototype.relations||(t.prototype.relations=[]),t.prototype.relations.push(n),e.each(t._subModels,function(t){r(t,n)},this)};r(t.model,t),this.retroFitRelation(t)}},retroFitRelation:function(t){var e=this.getCollection(t.model);e.each(function(e){e instanceof t.model&&new t.type(e,t)},this)},getCollection:function(n){n instanceof t.RelationalModel&&(n=n.constructor);for(var r=n;r._superModel;)r=r._superModel;var i=e.detect(this._collections,function(t){return t.model===r});return i||(i=this._createCollection(r)),i},getObjectByName:function(t){var n=t.split("."),r=null;return e.find(this._modelScopes,function(t){return r=e.reduce(n,function(t,e){return t[e]},t),r&&r!==t?!0:void 0},this),r},_createCollection:function(e){var n;return e instanceof t.RelationalModel&&(e=e.constructor),e.prototype instanceof t.RelationalModel&&(n=new t.Collection,n.model=e,this._collections.push(n)),n},resolveIdForItem:function(n,r){var i=e.isString(r)||e.isNumber(r)?r:null;return null===i&&(r instanceof t.RelationalModel?i=r.id:e.isObject(r)&&(i=r[n.prototype.idAttribute])),i||0===i||(i=null),i},find:function(t,e){var n=this.resolveIdForItem(t,e),r=this.getCollection(t);if(r){var i=r.get(n);if(i instanceof t)return i}return null},register:function(t){var e=t.collection,n=this.getCollection(t);n&&n.add(t),t.bind("destroy",this.unregister,this),t.collection=e},update:function(t){var e=this.getCollection(t);e._onModelEvent("change:"+t.idAttribute,t,e)},unregister:function(t){t.unbind("destroy",this.unregister);var e=this.getCollection(t);e&&e.remove(t)}}),t.Relational.store=new t.Store,t.Relation=function(n,r){return this.instance=n,r=e.isObject(r)?r:{},this.reverseRelation=e.defaults(r.reverseRelation||{},this.options.reverseRelation),this.reverseRelation.type=e.isString(this.reverseRelation.type)?t[this.reverseRelation.type]||t.Relational.store.getObjectByName(this.reverseRelation.type):this.reverseRelation.type,this.model=r.model||this.instance.constructor,this.options=e.defaults(r,this.options,t.Relation.prototype.options),this.key=this.options.key,this.keySource=this.options.keySource||this.key,this.keyDestination=this.options.keyDestination||this.keySource||this.key,this.relatedModel=this.options.relatedModel,e.isString(this.relatedModel)&&(this.relatedModel=t.Relational.store.getObjectByName(this.relatedModel)),this.checkPreconditions()?(n&&(this.keyContents=this.instance.get(this.keySource),this.key!==this.keySource&&this.instance.unset(this.keySource,{silent:!0}),this.instance._relations.push(this)),!this.options.isAutoRelation&&this.reverseRelation.type&&this.reverseRelation.key&&t.Relational.store.addReverseRelation(e.defaults({isAutoRelation:!0,model:this.relatedModel,relatedModel:this.model,reverseRelation:this.options},this.reverseRelation)),e.bindAll(this,"_modelRemovedFromCollection","_relatedModelAdded","_relatedModelRemoved"),n&&(this.initialize(),t.Relational.store.getCollection(this.instance).bind("relational:remove",this._modelRemovedFromCollection),t.Relational.store.getCollection(this.relatedModel).bind("relational:add",this._relatedModelAdded).bind("relational:remove",this._relatedModelRemoved)),void 0):!1},t.Relation.extend=t.Model.extend,e.extend(t.Relation.prototype,t.Events,t.Semaphore,{options:{createModels:!0,includeInJSON:!0,isAutoRelation:!1},instance:null,key:null,keyContents:null,relatedModel:null,reverseRelation:null,related:null,_relatedModelAdded:function(t,e,n){var r=this;t.queue(function(){r.tryAddRelated(t,n)})},_relatedModelRemoved:function(t,e,n){this.removeRelated(t,n)},_modelRemovedFromCollection:function(t){t===this.instance&&this.destroy()},checkPreconditions:function(){var n=this.instance,r=this.key,i=this.model,o=this.relatedModel,a=t.Relational.showWarnings&&"undefined"!=typeof console;if(!i||!r||!o)return a&&console.warn("Relation=%o; no model, key or relatedModel (%o, %o, %o)",this,i,r,o),!1;if(!(i.prototype instanceof t.RelationalModel))return a&&console.warn("Relation=%o; model does not inherit from Backbone.RelationalModel (%o)",this,n),!1;if(!(o.prototype instanceof t.RelationalModel))return a&&console.warn("Relation=%o; relatedModel does not inherit from Backbone.RelationalModel (%o)",this,o),!1;if(this instanceof t.HasMany&&this.reverseRelation.type===t.HasMany)return a&&console.warn("Relation=%o; relation is a HasMany, and the reverseRelation is HasMany as well.",this),!1;if(n&&n._relations.length){var u=e.any(n._relations,function(t){var e=this.reverseRelation.key&&t.reverseRelation.key;return t.relatedModel===o&&t.key===r&&(!e||this.reverseRelation.key===t.reverseRelation.key)},this);if(u)return a&&console.warn("Relation=%o between instance=%o.%s and relatedModel=%o.%s already exists",this,n,r,o,this.reverseRelation.key),!1}return!0},setRelated:function(t,n){this.related=t,this.instance.acquire(),this.instance.set(this.key,t,e.defaults(n||{},{silent:!0})),this.instance.release()},_isReverseRelation:function(t){return t.instance instanceof this.relatedModel&&this.reverseRelation.key===t.key&&this.key===t.reverseRelation.key?!0:!1},getReverseRelations:function(t){var n=[],r=e.isUndefined(t)?this.related&&(this.related.models||[this.related]):[t];return e.each(r,function(t){e.each(t.getRelations(),function(t){this._isReverseRelation(t)&&n.push(t)},this)},this),n},sanitizeOptions:function(t){return t=t?e.clone(t):{},t.silent&&(t.silentChange=!0,delete t.silent),t},unsanitizeOptions:function(t){return t=t?e.clone(t):{},t.silentChange&&(t.silent=!0,delete t.silentChange),t},destroy:function(){t.Relational.store.getCollection(this.instance).unbind("relational:remove",this._modelRemovedFromCollection),t.Relational.store.getCollection(this.relatedModel).unbind("relational:add",this._relatedModelAdded).unbind("relational:remove",this._relatedModelRemoved),e.each(this.getReverseRelations(),function(t){t.removeRelated(this.instance)},this)}}),t.HasOne=t.Relation.extend({options:{reverseRelation:{type:"HasMany"}},initialize:function(){e.bindAll(this,"onChange"),this.instance.bind("relational:change:"+this.key,this.onChange);var t=this.findRelated({silent:!0});this.setRelated(t),e.each(this.getReverseRelations(),function(t){t.addRelated(this.instance)},this)},findRelated:function(){var t=this.keyContents,e=null;return t instanceof this.relatedModel?e=t:(t||0===t)&&(e=this.relatedModel.findOrCreate(t,{create:this.options.createModels})),e},onChange:function(n,r,i){if(!this.isLocked()){this.acquire(),i=this.sanitizeOptions(i);var o=e.isUndefined(i._related),a=o?this.related:i._related;if(o)if(this.keyContents=r,r instanceof this.relatedModel)this.related=r;else if(r){var u=this.findRelated(i);this.setRelated(u)}else this.setRelated(null);if(a&&this.related!==a&&e.each(this.getReverseRelations(a),function(t){t.removeRelated(this.instance,i)},this),e.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,i)},this),!i.silentChange&&this.related!==a){var s=this;t.Relational.eventQueue.add(function(){s.instance.trigger("update:"+s.key,s.instance,s.related,i)})}this.release()}},tryAddRelated:function(n,r){if(!this.related){r=this.sanitizeOptions(r);var i=this.keyContents;if(i||0===i){var o=t.Relational.store.resolveIdForItem(this.relatedModel,i);e.isNull(o)||n.id!==o||this.addRelated(n,r)}}},addRelated:function(t){if(t!==this.related){var e=this.related||null;this.setRelated(t),this.onChange(this.instance,t,{_related:e})}},removeRelated:function(t){if(this.related&&t===this.related){var e=this.related||null;this.setRelated(null),this.onChange(this.instance,t,{_related:e})}}}),t.HasMany=t.Relation.extend({collectionType:null,options:{reverseRelation:{type:"HasOne"},collectionType:t.Collection,collectionKey:!0,collectionOptions:{}},initialize:function(){if(e.bindAll(this,"onChange","handleAddition","handleRemoval","handleReset"),this.instance.bind("relational:change:"+this.key,this.onChange),this.collectionType=this.options.collectionType,e.isString(this.collectionType)&&(this.collectionType=t.Relational.store.getObjectByName(this.collectionType)),!this.collectionType.prototype instanceof t.Collection)throw Error("collectionType must inherit from Backbone.Collection");this.keyContents instanceof t.Collection?this.setRelated(this._prepareCollection(this.keyContents)):this.setRelated(this._prepareCollection()),this.findRelated({silent:!0})},_getCollectionOptions:function(){return e.isFunction(this.options.collectionOptions)?this.options.collectionOptions(this.instance):this.options.collectionOptions},_prepareCollection:function(e){if(this.related&&this.related.unbind("relational:add",this.handleAddition).unbind("relational:remove",this.handleRemoval).unbind("relational:reset",this.handleReset),e&&e instanceof t.Collection||(e=new this.collectionType([],this._getCollectionOptions())),e.model=this.relatedModel,this.options.collectionKey){var n=this.options.collectionKey===!0?this.options.reverseRelation.key:this.options.collectionKey;e[n]&&e[n]!==this.instance?t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; collectionKey=%s already exists on collection=%o",this,n,this.options.collectionKey):n&&(e[n]=this.instance)}return e.bind("relational:add",this.handleAddition).bind("relational:remove",this.handleRemoval).bind("relational:reset",this.handleReset),e},findRelated:function(n){if(this.keyContents){var r=[];this.keyContents instanceof t.Collection?r=this.keyContents.models:(this.keyContents=e.isArray(this.keyContents)?this.keyContents:[this.keyContents],e.each(this.keyContents,function(t){var e=null;t instanceof this.relatedModel?e=t:(t||0===t)&&(e=this.relatedModel.findOrCreate(t,{create:this.options.createModels})),!e||this.related.getByCid(e)||this.related.get(e)||r.push(e)},this)),r.length&&(n=this.unsanitizeOptions(n),this.related.add(r,n))}},onChange:function(n,r,i){if(i=this.sanitizeOptions(i),this.keyContents=r,e.each(this.getReverseRelations(),function(t){t.removeRelated(this.instance,i)},this),r instanceof t.Collection)this._prepareCollection(r),this.related=r;else{var o;this.related instanceof t.Collection?(o=this.related,o.remove(o.models)):o=this._prepareCollection(),this.setRelated(o),this.findRelated(i)}e.each(this.getReverseRelations(),function(t){t.addRelated(this.instance,i)},this);var a=this;t.Relational.eventQueue.add(function(){!i.silentChange&&a.instance.trigger("update:"+a.key,a.instance,a.related,i)})},tryAddRelated:function(n,r){if(r=this.sanitizeOptions(r),!this.related.getByCid(n)&&!this.related.get(n)){var i=e.any(this.keyContents,function(r){var i=t.Relational.store.resolveIdForItem(this.relatedModel,r);return!e.isNull(i)&&i===n.id},this);i&&this.related.add(n,r)}},handleAddition:function(n,r,i){if(n instanceof t.Model){i=this.sanitizeOptions(i),e.each(this.getReverseRelations(n),function(t){t.addRelated(this.instance,i)},this);var o=this;t.Relational.eventQueue.add(function(){!i.silentChange&&o.instance.trigger("add:"+o.key,n,o.related,i)})}},handleRemoval:function(n,r,i){if(n instanceof t.Model){i=this.sanitizeOptions(i),e.each(this.getReverseRelations(n),function(t){t.removeRelated(this.instance,i)},this);var o=this;t.Relational.eventQueue.add(function(){!i.silentChange&&o.instance.trigger("remove:"+o.key,n,o.related,i)})}},handleReset:function(e,n){n=this.sanitizeOptions(n);var r=this;t.Relational.eventQueue.add(function(){!n.silentChange&&r.instance.trigger("reset:"+r.key,r.related,n)})},addRelated:function(t,e){var n=this;e=this.unsanitizeOptions(e),t.queue(function(){!n.related||n.related.getByCid(t)||n.related.get(t)||n.related.add(t,e)})},removeRelated:function(t,e){e=this.unsanitizeOptions(e),(this.related.getByCid(t)||this.related.get(t))&&this.related.remove(t,e)}}),t.RelationalModel=t.Model.extend({relations:null,_relations:null,_isInitialized:!1,_deferProcessing:!1,_queue:null,subModelTypeAttribute:"type",subModelTypes:null,constructor:function(n,r){var i=this;if(r&&r.collection){this._deferProcessing=!0;var o=function(t){t===i&&(i._deferProcessing=!1,i.processQueue(),r.collection.unbind("relational:add",o))};r.collection.bind("relational:add",o),e.defer(function(){o(i)})}this._queue=new t.BlockingQueue,this._queue.block(),t.Relational.eventQueue.block(),t.Model.apply(this,arguments),t.Relational.eventQueue.unblock()},trigger:function(e){if(e.length>5&&"change"===e.substr(0,6)){var n=this,r=arguments;t.Relational.eventQueue.add(function(){t.Model.prototype.trigger.apply(n,r)})}else t.Model.prototype.trigger.apply(this,arguments);return this},initializeRelations:function(){this.acquire(),this._relations=[],e.each(this.relations,function(n){var r=e.isString(n.type)?t[n.type]||t.Relational.store.getObjectByName(n.type):n.type;r&&r.prototype instanceof t.Relation?new r(this,n):t.Relational.showWarnings&&"undefined"!=typeof console&&console.warn("Relation=%o; missing or invalid type!",n)},this),this._isInitialized=!0,this.release(),this.processQueue()},updateRelations:function(t){this._isInitialized&&!this.isLocked()&&e.each(this._relations,function(e){var n=this.attributes[e.keySource]||this.attributes[e.key];e.related!==n&&this.trigger("relational:change:"+e.key,this,n,t||{})},this)},queue:function(t){this._queue.add(t)},processQueue:function(){this._isInitialized&&!this._deferProcessing&&this._queue.isBlocked()&&this._queue.unblock()},getRelation:function(t){return e.detect(this._relations,function(e){return e.key===t?!0:void 0},this)},getRelations:function(){return this._relations},fetchRelated:function(n,r,i){r||(r={});var o,a=[],u=this.getRelation(n),s=u&&u.keyContents,l=s&&e.select(e.isArray(s)?s:[s],function(n){var r=t.Relational.store.resolveIdForItem(u.relatedModel,n);return!e.isNull(r)&&(i||!t.Relational.store.find(u.relatedModel,r))},this);if(l&&l.length){var c=e.map(l,function(t){var n;if(e.isObject(t))n=u.relatedModel.build(t);else{var r={};r[u.relatedModel.prototype.idAttribute]=t,n=u.relatedModel.build(r)}return n},this);if(u.related instanceof t.Collection&&e.isFunction(u.related.url)&&(o=u.related.url(c)),o&&o!==u.related.url()){var f=e.defaults({error:function(){var t=arguments;e.each(c,function(e){e.trigger("destroy",e,e.collection,r),r.error&&r.error.apply(e,t)})},url:o},r,{add:!0});a=[u.related.fetch(f)]}else a=e.map(c,function(t){var n=e.defaults({error:function(){t.trigger("destroy",t,t.collection,r),r.error&&r.error.apply(t,arguments)}},r);return t.fetch(n)},this)}return a},set:function(n,r,i){t.Relational.eventQueue.block();var o;e.isObject(n)||null==n?(o=n,i=r):(o={},o[n]=r);var a=t.Model.prototype.set.apply(this,arguments);return this._isInitialized||this.isLocked()?o&&this.idAttribute in o&&t.Relational.store.update(this):(this.constructor.initializeModelHierarchy(),t.Relational.store.register(this),this.initializeRelations()),o&&this.updateRelations(i),t.Relational.eventQueue.unblock(),a},unset:function(e,n){t.Relational.eventQueue.block();var r=t.Model.prototype.unset.apply(this,arguments);return this.updateRelations(n),t.Relational.eventQueue.unblock(),r},clear:function(e){t.Relational.eventQueue.block();var n=t.Model.prototype.clear.apply(this,arguments);return this.updateRelations(e),t.Relational.eventQueue.unblock(),n},change:function(){var e=this,n=arguments;t.Relational.eventQueue.add(function(){t.Model.prototype.change.apply(e,n)})},clone:function(){var t=e.clone(this.attributes);return e.isUndefined(t[this.idAttribute])||(t[this.idAttribute]=null),e.each(this.getRelations(),function(e){delete t[e.key]}),new this.constructor(t)},toJSON:function(){if(this.isLocked())return this.id;this.acquire();var n=t.Model.prototype.toJSON.call(this);return!this.constructor._superModel||this.constructor._subModelTypeAttribute in n||(n[this.constructor._subModelTypeAttribute]=this.constructor._subModelTypeValue),e.each(this._relations,function(r){var i=n[r.key];if(r.options.includeInJSON===!0)n[r.keyDestination]=i&&e.isFunction(i.toJSON)?i.toJSON():null;else if(e.isString(r.options.includeInJSON))n[r.keyDestination]=i instanceof t.Collection?i.pluck(r.options.includeInJSON):i instanceof t.Model?i.get(r.options.includeInJSON):null;else if(e.isArray(r.options.includeInJSON))if(i instanceof t.Collection){var o=[];i.each(function(t){var n={};e.each(r.options.includeInJSON,function(e){n[e]=t.get(e)}),o.push(n)}),n[r.keyDestination]=o}else if(i instanceof t.Model){var o={};e.each(r.options.includeInJSON,function(t){o[t]=i.get(t)}),n[r.keyDestination]=o}else n[r.keyDestination]=null;else e.isObject(r.options.includeInJSON)?i instanceof t.Model&&e.each(r.options.includeInJSON,function(t,e){n[t]=i.get(e)}):delete n[r.key];r.keyDestination!==r.key&&delete n[r.key]}),this.release(),n}},{setup:function(){return this.prototype.relations=(this.prototype.relations||[]).slice(0),this._subModels={},this._superModel=null,this.prototype.hasOwnProperty("subModelTypes")?t.Relational.store.addSubModels(this.prototype.subModelTypes,this):this.prototype.subModelTypes=null,e.each(this.prototype.relations,function(n){if(n.model||(n.model=this),n.reverseRelation&&n.model===this){var r=!0;if(e.isString(n.relatedModel)){var i=t.Relational.store.getObjectByName(n.relatedModel);r=i&&i.prototype instanceof t.RelationalModel}var o=e.isString(n.type)?t[n.type]||t.Relational.store.getObjectByName(n.type):n.type;r&&o&&o.prototype instanceof t.Relation&&new o(null,n)}},this),this},build:function(t,e){var n=this;if(this.initializeModelHierarchy(),this._subModels&&this.prototype.subModelTypeAttribute in t){var r=t[this.prototype.subModelTypeAttribute],i=this._subModels[r];i&&(n=i)}return new n(t,e)},initializeModelHierarchy:function(){if(e.isUndefined(this._superModel)||e.isNull(this._superModel))if(t.Relational.store.setupSuperModel(this),this._superModel){if(this._superModel.prototype.relations){var n=e.any(this.prototype.relations,function(t){return t.model&&t.model!==this},this);n||(this.prototype.relations=this._superModel.prototype.relations.concat(this.prototype.relations))}}else this._superModel=!1;this.prototype.subModelTypes&&e.keys(this.prototype.subModelTypes).length!==e.keys(this._subModels).length&&e.each(this.prototype.subModelTypes,function(e){var n=t.Relational.store.getObjectByName(e);n&&n.initializeModelHierarchy()})},findOrCreate:function(n,r){var i=t.Relational.store.find(this,n);return e.isObject(n)&&(i?i.set(n,r):(!r||r&&r.create!==!1)&&(i=this.build(n,r))),i}}),e.extend(t.RelationalModel.prototype,t.Semaphore),t.Collection.prototype.__prepareModel=t.Collection.prototype._prepareModel,t.Collection.prototype._prepareModel=function(e,n){if(n||(n={}),e instanceof t.Model)e.collection||(e.collection=this);else{var r=e;n.collection=this,e=this.model.build!==void 0?this.model.build(r,n):new this.model(r,n),e._validate(e.attributes,n)||(e=!1)}return e};var r=t.Collection.prototype.__add=t.Collection.prototype.add;t.Collection.prototype.add=function(n,i){i||(i={}),e.isArray(n)||(n=[n]);var o=[];return e.each(n,function(e){if(!(e instanceof t.Model)){var n=t.Relational.store.find(this.model,e[this.model.prototype.idAttribute]);n?(n.set(n.parse?n.parse(e):e,i),e=n):e=t.Collection.prototype._prepareModel.call(this,e,i)}e instanceof t.Model&&!this.get(e)&&!this.getByCid(e)&&o.push(e)},this),o.length&&(r.call(this,o,i),e.each(o,function(t){this.trigger("relational:add",t,this,i)},this)),this};var i=t.Collection.prototype.__remove=t.Collection.prototype.remove;t.Collection.prototype.remove=function(n,r){return r||(r={}),n=e.isArray(n)?n.slice(0):[n],e.each(n,function(e){e=this.getByCid(e)||this.get(e),e instanceof t.Model&&(i.call(this,e,r),this.trigger("relational:remove",e,this,r))},this),this};var o=t.Collection.prototype.__reset=t.Collection.prototype.reset;t.Collection.prototype.reset=function(t,e){return o.call(this,t,e),this.trigger("relational:reset",this,e),this};var a=t.Collection.prototype.__sort=t.Collection.prototype.sort;t.Collection.prototype.sort=function(t){return a.call(this,t),this.trigger("relational:reset",this,t),this};var u=t.Collection.prototype.__trigger=t.Collection.prototype.trigger;t.Collection.prototype.trigger=function(n){if("add"===n||"remove"===n||"reset"===n){var r=this,i=arguments;"add"===n&&(i=e.toArray(i),e.isObject(i[3])&&(i[3]=e.clone(i[3]))),t.Relational.eventQueue.add(function(){u.apply(r,i)})}else u.apply(this,arguments);return this},t.RelationalModel.extend=function(){var e=t.Model.extend.apply(this,arguments);return e.setup(this),e}});