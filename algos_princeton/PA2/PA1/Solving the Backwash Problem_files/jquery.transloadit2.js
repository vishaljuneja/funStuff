define(["jquery","js/lib/jquery.easing","js/lib/jquery.jsonp","js/lib/json2"],function(t){function e(){this.assemblyId=null,this.instance=null,this.documentTitle=null,this.timer=null,this._options={},this.uploads=[],this.results={},this.ended=null,this.pollStarted=null,this.pollRetries=0,this.seq=0,this.started=!1,this.assembly=null,this.params=null,this.bytesReceivedBefore=0,this.lastPoll=0,this.$params=null,this.$form=null,this.$files=null,this.$fileClones=null,this.$iframe=null,this.$modal=null}var n="https:"==document.location.protocol?"https://":"http://",r={service:n+"api2.transloadit.com/",assets:n+"assets.transloadit.com/",onPick:function(){},onStart:function(){},onProgress:function(){},onUpload:function(){},onResult:function(){},onCancel:function(){},onError:function(){},onSuccess:function(){},interval:2500,pollTimeout:8e3,poll404Retries:15,pollConnectionRetries:3,wait:!1,processZeroFiles:!0,autoSubmit:!0,modal:!0,exclude:"",fields:!1,params:null,debug:!0},i=!1;t.fn.transloadit=function(){var t,n,r,i=Array.prototype.slice.call(arguments);if((1==i.length&&"object"==typeof i[0]||void 0===i[0])&&i.unshift("init"),t=i.shift(),"init"==t?(n=new e,i.unshift(this),this.data("transloadit.uploader",n)):n=this.data("transloadit.uploader"),!n)throw Error("Element is not initialized for transloadit!");return r=n[t].apply(n,i),void 0===r?this:r},e.prototype.init=function(e,n){this.$form=e,this.options(t.extend({},r,n||{}));var i=this;e.find('input[type="file"]').on("change",function(){return i.validate(),i.detectFileInputs(),i.checkFileTypes(),i._options.processZeroFiles||0!==i.$files.length?(i._options.onPick(),i.getBoredInstance()):i.submitForm(),!1}),this.includeCss()},e.prototype.getBoredInstance=function(){var e=this;this.instance=null,t.jsonp({url:this._options.service+"instances/bored",timeout:e._options.pollTimeout,callbackParameter:"callback",success:function(t){return t.error?(e.ended=!0,e.renderError(t),e._options.onError(t),void 0):(e.instance=t.api2_host,e.start(),void 0)},error:function(t,n){e.ended=!0;var r={error:"CONNECTION_ERROR",message:"There was a problem connecting to the upload server",reason:"JSONP request status: "+n};e.renderError(r),e._options.onError(r)}}),this._options.modal&&this.showModal()},e.prototype.start=function(){var e=this;this.started=!1,this.ended=!1,this.bytesReceivedBefore=0,this.pollRetries=0,this.seq=0,this.uploads=[],this.results={},this.assemblyId=this.uuid(),this.$fileClones=t().not(document),this.$files.each(function(){var n=t(this).clone(!0);e.$fileClones=e.$fileClones.add(n),n.insertAfter(this)}),this.$iframe=t('<iframe id="transloadit-'+this.assemblyId+'" name="transloadit-'+this.assemblyId+'"/>').appendTo("body").hide(),this.$uploadForm=t('<form enctype="multipart/form-data" />').attr("action",n+this.instance+"/assemblies/"+this.assemblyId+"?redirect=false").attr("target","transloadit-"+this.assemblyId).attr("method","POST").append(this.$files).appendTo("body").hide();var r="[name=params], [name=signature]";this._options.fields===!0?r="*":"string"==typeof this._options.fields&&(r+=", "+this._options.fields);var i=this.clone(this.$form.find(":input[type!=file]").filter(r));this._options.params&&!this.$params&&(i=i.add('<input name="params" value=\''+JSON.stringify(this._options.params)+"'>")),i.prependTo(this.$uploadForm),this.$uploadForm.submit(),this.lastPoll=+new Date,setTimeout(function(){e._poll()},300)},e.prototype.clone=function(e){for(var n=e.clone(),r=e.filter("textarea"),i=n.filter("textarea"),o=0,a=r.length;a>o;++o)t(i[o]).val(t(r[o]).val());return n},e.prototype.checkFileTypes=function(){var t=this,e=t.$files.attr("accept");return e?("video/*"==e&&(e="video/mp4,video/m4v,video/flv,video/avi,video/mpg,video/mov,video/wmv,video/h264,video/mkv"),"image/*"==e&&(e="image/png,image/jpeg,image/gif,image/jpg,image/ico"),e=e.split(","),t.$files=t.$files.filter(function(){for(var n=this.value.split(".").pop().toLowerCase(),r=0;e.length>r;r++)if(n==e[r].split("/")[1])return!0;return t._options.onError("Sorry, we don't accept "+n+" files."),!1}),void 0):!0},e.prototype.detectFileInputs=function(){var t=this.$form.find("input[type=file]").not(this._options.exclude);this._options.processZeroFiles||(t=t.filter(function(){return""!==this.value})),this.$files=t},e.prototype.validate=function(){if(this._options.params)this.params=this._options.params;else{var t=this.$form.find("input[name=params]");if(!t.length)return alert("Could not find input[name=params] in your form."),void 0;try{this.params=JSON.parse(t.val())}catch(e){return alert("Error: input[name=params] seems to contain invalid JSON."),void 0}}if(this.params.redirect_url)this.$form.attr("action",this.params.redirect_url);else if(this._options.autoSubmit&&this.$form.attr("action")==this._options.service+"assemblies")return alert("Error: input[name=params] does not include a redirect_url"),void 0;this.$params=t},e.prototype._poll=function(e){var r=this;this.ended||(t.browser.mozilla&&!this.documentTitle&&(this.documentTitle=document.title,document.title="Loading..."),this.pollStarted=+new Date,t.jsonp({url:n+this.instance+"/assemblies/"+this.assemblyId+(e||"?seq="+this.seq),timeout:r._options.pollTimeout,callbackParameter:"callback",success:function(t){if(!r.ended){if(r.assembly=t,"ASSEMBLY_NOT_FOUND"==t.error)return r.pollRetries++,r.pollRetries>r._options.poll404Retries?(document.title=r.documentTitle,r.ended=!0,r.renderError(t),r._options.onError(t),void 0):(setTimeout(function(){r._poll()},400),void 0);if(t.error)return r.ended=!0,r.renderError(t),document.title=r.documentTitle,r._options.onError(t),void 0;r.seq=t.last_seq,r.started||(r.started=!0,r._options.onStart(t)),r.pollRetries=0;var e=("ASSEMBLY_UPLOADING"==t.ok,"ASSEMBLY_EXECUTING"==t.ok),n="ASSEMBLY_CANCELED"==t.ok,i="ASSEMBLY_COMPLETED"==t.ok;r._options.onProgress(t.bytes_received,t.bytes_expected,t);for(var o=0;t.uploads.length>o;o++)r._options.onUpload(t.uploads[o],t),r.uploads.push(t.uploads[o]);for(var a in t.results){r.results[a]=r.results[a]||[];for(var o=0;t.results[a].length>o;o++)r._options.onResult(a,t.results[a][o],t),r.results[a].push(t.results[a][o])}if(n)return r.ended=!0,document.title=r.documentTitle,r._options.onCancel(t),void 0;if(r.renderProgress(t),i||!r._options.wait&&e)return r.ended=!0,document.title=r.documentTitle,t.uploads=r.uploads,t.results=r.results,r._options.onSuccess(t),r._options.modal&&r.cancel(),r.submitForm(),void 0;var s=r.pollStarted-+new Date,u=r._options.interval>s?r._options.interval:s;r.timer=setTimeout(function(){r._poll()},u),r.lastPoll=+new Date}},error:function(t,e){if(!r.ended){if(r.pollRetries++,r.pollRetries>r._options.pollConnectionRetries){document.title=r.documentTitle,r.ended=!0;var n={error:"CONNECTION_ERROR",message:"There was a problem connecting to the upload server",reason:"JSONP request status: "+e};return r.renderError(n),r._options.onError(n),void 0}setTimeout(function(){r._poll()},350)}}}))},e.prototype.stop=function(){document.title=this.documentTitle,this.ended=!0},e.prototype.cancel=function(){if(!this.ended){var e=this;this.$params&&this.$params.prependTo(this.$form),this.$fileClones.each(function(n){var r=t(e.$files[n]),i=t(this);r.insertAfter(i),i.remove()}),clearTimeout(e.timer),this._poll("?method=delete"),"Microsoft Internet Explorer"==navigator.appName&&this.$iframe[0].contentWindow.document.execCommand("Stop"),setTimeout(function(){e.$iframe.remove()},500)}this._options.modal&&(t.mask.close(),this.$modal.remove())},e.prototype.submitForm=function(){this.$fileClones,null!==this.assembly&&t("<textarea/>").attr("name","transloadit").text(JSON.stringify(this.assembly)).prependTo(this.$form).hide(),this._options.autoSubmit&&this.$form.unbind("submit.transloadit").submit()},e.prototype.showModal=function(){this.$modal=t('<div id="transloadit"><div class="content"><a href="#close" class="close"></a><p class="status"></p><div class="progress"><label>starting upload ...</label><span></span></div><p class="error"></p></div></div>').appendTo("body"),t.extend(this.$modal,{$status:this.$modal.find(".status"),$content:this.$modal.find(".content"),$close:this.$modal.find(".close"),$label:this.$modal.find("label"),$progress:this.$modal.find(".progress"),$progressSpan:this.$modal.find(".progress span"),$error:this.$modal.find(".error")});var e=this;this.$modal.$close.click(function(){e.cancel()}),this.$modal.$error.hide();var e=this;this.$modal.expose({api:!0,maskId:"transloadit_expose",opacity:.9,loadSpeed:250,closeOnEsc:!1,closeOnClick:!1}),this.$modal.$close.click(function(){return e.cancel(),!1})},e.prototype.renderError=function(t){if(this._options.modal){this.$modal.$content.addClass("content-error"),this.$modal.$progress.hide();var e=this._options.debug?t.error+": "+t.message+"<br><br>"+(t.reason||""):"There was an internal error, please try your upload again.";this.$modal.$error.html(e).show()}},e.prototype.renderProgress=function(t){if(this._options.modal){var e=t.bytes_received/t.bytes_expected,n=t.bytes_received-this.bytesReceivedBefore,r=+new Date-this.lastPoll,i=1==e?1e3:2*this._options.interval,o=1==e?"processing ...":(t.bytes_received/1024/1024).toFixed(2)+" MB / "+(t.bytes_expected/1024/1024).toFixed(2)+" MB "+"("+(n/1024/(r/1e3)).toFixed(1)+" kB / sec)";this.bytesReceivedBefore=t.bytes_received,this.$modal.$label.text(o),this.$modal.$progressSpan.stop().animate({width:100*e+"%"},i,"easeOutCubic")}},e.prototype.includeCss=function(){!i&&this._options.modal&&(i=!0,t('<link rel="stylesheet" type="text/css" href="'+this._options.assets+'css/transloadit2.css" />').appendTo("head"))},e.prototype.uuid=function(){var t,e="";for(t=0;32>t;t++)e+=Math.floor(16*Math.random()).toString(16);return e},e.prototype.options=function(e){return 0==arguments.length?this._options:(t.extend(this._options,e),void 0)},e.prototype.option=function(t,e){return 1==arguments.length?this._options[t]:(this._options[t]=e,void 0)}});