define(["backbone","jquery","underscore","pages/forum/app","pages/forum/views/ThreadTagsView.html","js/lib/select2"],function(e,t,o,n,r){var i="Forum Thread",s=e.View.extend({defaults:{},events:{"click .course-forum-thread-tags-link":"onThreadTagsClick","click .course-forum-thread-tags-form button":"onThreadTagsSave","click .course-forum-thread-tags-form a":"onThreadTagsCancel","click .course-forum-thread-tag-delete":"onThreadTagDelete"},initialize:function(){this.thread=this.model,this.thread.bind("change",this.render,this)},render:function(){var e=this.thread.changedAttributes();return(!this.$(".course-forum-thread-tags-form").length||e&&o.intersection(o.keys(e),["tags"]).length>0)&&(this.$el.html(r({config:n.config,thread:this.thread})),this.$form=this.$(".course-forum-thread-tags-form")),this},onThreadTagsClick:function(e){e.preventDefault();var t=this;t.$form.show(),n.api.get("forum/tags",{message:{waiting:"Fetching tags..."}}).done(function(e){var n=o.pluck(t.thread.get("tags"),"tag_name"),r=o.pluck(e,"tag_name"),i=o.without(r,n);t.$form.find("input").select2({width:"400px",tags:i}),t.$form.find("button").attr("disabled",null)})},onThreadTagsSave:function(e){e.preventDefault();var t=this,r=t.$("input[name=tags]").val().split(","),s=o.map(o.uniq(r),function(e){return{tag_name:e}});n.api.post(this.thread.tagsUrl(),{data:s,message:{waiting:"Saving tags...",success:"Saved tags!"}}).done(function(e){t.thread.set({tags:e})}),t.$form.find("button").attr("disabled","disabled"),n.multitracker.push([i,"Tags Save"])},onThreadTagsCancel:function(e){var t=this;e.preventDefault(),t.$form[0].reset(),t.$form.hide(),n.multitracker.push([i,"Tags Cancel"])},onThreadTagDelete:function(e){e.preventDefault();var o=this,r=[{tag_name:t(e.target).attr("data-tag")}];n.api["delete"](this.thread.tagsUrl(),{data:r,message:{waiting:"Deleting tag...",success:"Deleted tag"}}).done(function(e){o.thread.set({tags:e})}),n.multitracker.push([i,"Tag Delete"])}});return s});