(function(e){var t=0,s=function(e,s,i,o){var r={defaults:{type:"normal","csrf.token":"X-CSRFToken","csrf.cookie":"csrftoken","csrf.path":null,"csrf.domain":null,"emulate.patch":!0,"emulate.put":!1,"emulate.delete":!1},csrfGet:function(){var e=i.get(this.options["csrf.cookie"]);return e?e:r.csrfSet.call(this,r.csrfMake())},csrfClear:function(){i.clear(this.options["csrf.cookie"],{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"]})},csrfSet:function(e){return i.set(this.options["csrf.cookie"],e,{secure:this.options["csrf.secure"],path:this.options["csrf.path"],domain:this.options["csrf.domain"],expires:new Date((new Date).getTime()+6e4)}),e},csrfMake:function(e,t){var s=[];t=t||"0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ",e=e||24;for(var i=0;e>i;i++)s.push(t[Math.floor(Math.random()*t.length)]);return s.join("")},invoke:function(i,o){var a,n=o||{},c="GET"==n.type?n.data:null;a=0!==i.indexOf("http")?this.root+i:i;var d=function(e,t){this.remove(t.options.id)},u=n.message||{},p=u.codes?s.keys(u.codes):[],l=this.options.message,f=this;delete n.message,"GET"!=n.type&&s.isUndefined(n.processData)&&"rest"==this.options.type&&(n.contentType="application/json; charset=utf-8",n.processData=!1,n.data=JSON.stringify(n.data)),n.beforeSend=function(){t++};var h=e.ajax(a,n);if(l){if(u.waiting){var y=l.add(e("<div>").append(u.waiting).addClass("waiting"),{delay:100});h.always(function(){l.remove(y)})}(u.success||u.codes&&300>s.min(p))&&h.done(function(t){u.codes&&u.codes[t.status]?l.add(e("<div>").append(u.codes[t.status]).addClass("success"),{timeout:500}):u.success&&l.add(e("<div>").append(u.success).addClass("success"),{timeout:500})}),(u.error||u.timeout||u.codes&&s.max(p)>=300)&&h.fail(function(t,s){u.timeout&&"timeout"==s?l.add(e("<div>").append(u.timeout).addClass("error"),{events:{click:d}}):u.codes&&u.codes[t.status]?l.add(e("<div>").append(u.codes[jsXHR.status]).addClass("error"),{events:{click:d}}):u.error&&l.add(e("<div>").append(u.error).addClass("error"),{events:{click:d}})})}var T=(new Date).getTime();return f.trigger("send",{xhr:h,url:a}),h.always(function(){0===--t&&r.csrfClear.call(f),f.trigger("always",{xhr:h,url:a,params:c,timing:(new Date).getTime()-T})}),h.fail(function(){f.trigger("fail",{xhr:h,url:a,params:c})}),h},restify:function(e,t){var s=t||{};switch(s.data=s.data||{},s.headers=s.headers||{},e){case"POST":s.type="POST";break;case"PATCH":this.options["emulate.patch"]?(s.type="POST",s.headers["X-HTTP-Method-Override"]="PATCH"):s.type="PATCH";break;case"PUT":this.options["emulate.put"]?(s.type="POST",s.headers["X-HTTP-Method-Override"]="PUT"):s.type="PUT";break;case"DELETE":this.options["emulate.delete"]?(s.type="POST",s.headers["X-HTTP-Method-Override"]="DELETE"):s.type="DELETE";break;default:s.type="GET"}return"GET"!=s.type&&(s.headers[this.options["csrf.token"]]=r.csrfGet.call(this)),s}},a=function(e,t){this.root=e,this.options=s.extend({},r.defaults,t)};return a.prototype.get=function(e,t){return r.invoke.call(this,e,r.restify.call(this,"GET",t))},a.prototype.patch=function(e,t){return r.invoke.call(this,e,r.restify.call(this,"PATCH",t))},a.prototype["delete"]=function(e,t){return r.invoke.call(this,e,r.restify.call(this,"DELETE",t))},a.prototype.post=function(e,t){return r.invoke.call(this,e,r.restify.call(this,"POST",t))},a.prototype.put=function(e,t){return r.invoke.call(this,e,r.restify.call(this,"PUT",t))},s.extend(a.prototype,o.Events),function(e,t){return new a(e,t)}};"function"==typeof define&&define.amd?define(["jquery","underscore","js/lib/cookie","backbone","js/lib/json2"],function(e,t,i,o){return s(e,t,i,o)}):e.API=s(e.$,e._,e.Cookie,e.Backbone)})(window);