define(["jquery","underscore","backbone","js/lib/api","js/lib/util","pages/forum/app","pages/forum/models/PostModel","pages/forum/models/PostCollection","pages/forum/models/CommentModel","pages/forum/models/CommentCollection","js/lib/badgeville","js/lib/backbone.api","js/lib/backbone.relational"],function(t,e,r,s,i,o,a,n,u,d,c,l){var g=r.RelationalModel.extend({url:"forum/threads",subscriptionsUrl:function(){return this.url+"/"+this.get("id")+"/subscriptions"},tagsUrl:function(){return this.url+"/"+this.get("id")+"/tags"},triagePingUrl:function(){return this.url+"/"+this.get("id")+"/triage_ping"},api:o.api,partialUpdate:!0,defaults:{_user_profiles:{},tags:[],sort:"oldest"},relations:[{type:r.HasMany,key:"posts",relatedModel:a,collectionType:n,reverseRelation:{key:"thread"},includeInJSON:!0,collectionOptions:{comparator:function(t){return t.get("order")}}},{type:r.HasMany,key:"comments",relatedModel:u,collectionType:d,reverseRelation:{key:"thread"},includeInJSON:!0}],initialize:function(){this.bind("change",this.updateComputed,this),this.set("sort",i.getUrlParam(window.location,"sort"))},updateComputed:function(){var t=[];this.get("posts").each(function(e){t.push(e.get("user_id"))}),this.get("comments").each(function(e){t.push(e.get("user_id"))}),this.set("_user_ids",t,{silent:!0}),t.length>0&&(this.getUserProfiles(),this.updateProfilesOnEntries())},updateRange:function(){var t=this.getFirstPost(),e=this.getLastPost();this.set("start_range",t.get("order"),{silent:!0}),this.set("end_range",e.get("order"))},getPostsBefore:function(t){var r=this,s=r.getFirstPostId();this.api.get("forum/threads/"+this.get("id"),{data:{post_id:s,position:"before",sort:this.get("_sort_order")}}).done(e.bind(this.onFetchPosts,r,t))},getPostsAfter:function(t){var r=this,s=r.getLastPostId();this.api.get("forum/threads/"+this.get("id"),{data:{post_id:s,position:"after",sort:this.get("_sort_order")}}).done(e.bind(this.onFetchPosts,r,t))},onFetchPosts:function(t,e){e&&(this.get("posts").add(e.posts||[]),this.get("comments").add(e.comments||[])),this.updateRange(),t&&t.call(this)},getSavedPosts:function(){var t=this.get("posts").filter(function(t){return!t.isNew()});return t},getFullPosts:function(){var t=this.get("posts").filter(function(t){return t.get("post_time")});return t},getFirstPost:function(){return this.getFullPosts().shift()},getLastPost:function(){return this.getFullPosts().pop()},getFirstPostId:function(){return this.getFirstPost().get("id")},getLastPostId:function(){return this.getLastPost().get("id")},getCommentsForPost:function(t){var e=this.get("comments").filter(function(e){return e.get("post_id")==t.get("id")});return new d(e)},updateProfilesOnEntries:function(){var t=this;e.each(t.get("_user_profiles"),function(e){t.get("comments").each(function(t){t.get("user_id")!=e.id||t.get("_user_profile")||t.set("_user_profile",e)}),t.get("posts").each(function(t){t.get("user_id")!=e.id||t.get("_user_profile")||t.set("_user_profile",e)})})},getUserProfiles:function(){var t=this,r=e.filter(t.get("_user_ids"),function(e){return e&&!t.get("_user_profiles")[e]});r=e.uniq(r);var s=o.config.url.base+o.config.url.api+"user/profiles?user-ids="+r.join(",");o.apiWWW.get(s,{dataType:"jsonp",type:"get",success:function(r){e.each(r,function(e){t.get("_user_profiles")[e.id]||(t.get("_user_profiles")[e.id]=e),o.user.get("id")===e.id&&c.setPlayer({name:e.display_name,id:e.id,photo:e.photo_120})}),t.updateProfilesOnEntries()}})},getTotalVotes:function(){var t=0;return this.get("comments").each(function(e){t+=e.get("votes")||0}),this.get("posts").each(function(e){t+=e.get("votes")||0}),t},userContributed:function(t){var e=this,r=!1;return e.get("comments").each(function(e){e.get("user_id")==t&&(r=!0)}),e.get("posts").each(function(e){e.get("user_id")==t&&(r=!0)}),r},getURLForSortOrder:function(t){var e=window.location.pathname+window.location.search.split("&sort")[0]+"&sort="+t;return e},getTriageStatus:function(){var t=this;if(o.user.canModerateForum()&&t.get("id")&&t.get("courseId")){var e=o.config.url.base+o.config.url.api+"support/get_triage_status?"+"course_id="+t.get("courseId")+"&"+"thread_ids="+t.get("id");o.apiWWW.get(e,{dataType:"jsonp",type:"get",success:function(e){1==e.length&&t.set("triageStatus",e[0])}})}}});return e.extend(g.prototype,l),g});