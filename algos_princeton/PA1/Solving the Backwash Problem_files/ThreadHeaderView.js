define(["backbone","jquery","underscore","pages/forum/app","pages/forum/views/ThreadHeaderView.html","pages/forum/views/ThreadTitleEditView.html","pages/forum/views/PingView.html","js/lib/popups","js/lib/modals"],function(e,t,o,r,i,n,s,a,u){var c="Forum Thread",l=["title","stickied","approved","unresolved","locked","deleted","is_spam","_viewer_subscription","_viewer_can_delete","_viewer_can_edit_title","_viewer_can_resolve","triageStatus"],d=e.View.extend({defaults:{},events:{"click .course-forum-thread-action-link":"onThreadActionClick","click .course-forum-thread-controls-toggle .icon-cog":"onGearClick","click .course-forum-thread-subscribe-link":"onThreadSubscribeClick","click .course-forum-thread-unsubscribe-link":"onThreadUnsubscribeClick","click .course-forum-thread-edit-title-link":"onThreadEditTitleClick","click .course-forum-thread-title button":"onThreadEditTitleSave","click .course-forum-thread-title a":"onThreadEditTitleCancel","click .course-forum-thread-ping-coursera":"onThreadPingCourseraClick","click .course-forum-ping-coursera-send":"onThreadPingCourseraSend"},initialize:function(){this.thread=this.model,this.thread.bind("change",this.render,this)},render:function(){var e=this.thread.changedAttributes();return(!this.$(".course-forum-thread-controls").length||e&&o.intersection(o.keys(e),l).length>0)&&this.renderViewMode(),this},renderViewMode:function(){this.$el.html(i({config:r.config,user:r.user,thread:this.thread})),this.$title=this.$(".course-forum-thread-title")},onGearClick:function(){r.multitracker.push([c,"Controls Open"])},onThreadActionClick:function(e){var o=this,i=t(e.target),n=i.attr("data-property"),s=i.attr("data-value"),a={};a[n]=s,this.thread.update(a,{message:{waiting:"Processing...",success:"Processed!"}}).done(function(e){o.thread.set(e)}),r.multitracker.push([c,"Action "+n+" "+s])},onThreadEditTitleClick:function(){var e=this,t=e.$title.height();e.$title.html(n({user:r.user,thread:this.thread})),e.$title.find("form").height(t).focus(),e.$title.find("input").focus(),e.$title.find(".course-forum-thread-title button").attr("disabled",null),r.multitracker.push([c,"Title Edit Start"])},onThreadEditTitleSave:function(e){e.preventDefault();var t=this;t.thread.update({title:t.$("input").val()},{message:{waiting:"Saving title...",success:"Saved title!"}}).done(function(e){t.thread.set(e)}),t.$title.find(".course-forum-thread-title button").attr("disabled","disabled"),r.multitracker.push([c,"Title Edit Save"])},onThreadEditTitleCancel:function(e){e.preventDefault(),this.renderViewMode(),r.multitracker.push([c,"Title Edit Cancel"])},onThreadSubscribeClick:function(){var e=this;r.api.post(this.model.subscriptionsUrl(),{message:{waiting:"Subscribing...",success:"Subscribed!"}}).done(function(t){e.thread.set({_viewer_subscription:t})})},onThreadUnsubscribeClick:function(){var e=this;r.api["delete"](this.model.subscriptionsUrl(),{message:{waiting:"Unsubscribing...",success:"Unsubscribed!"}}).done(function(t){e.thread.set({_viewer_subscription:t})})},onThreadPingCourseraClick:function(){this.pingModal||(this.$el.append(s()),this.pingModal=new u(this.$(".course-forum-ping-modal"))),this.pingModal.open()},onThreadPingCourseraSend:function(){var e=this;r.api.post(e.model.triagePingUrl(),{message:{waiting:"Sending...",success:"Sent!"},data:{priority:e.$(".course-forum-ping-priority").val(),notes:e.$(".course-forum-ping-notes").val()}}).done(function(){e.thread.getTriageStatus(),e.$(".course-forum-ping-modal-status").text(""),e.pingModal.close()}).fail(function(t){e.$(".course-forum-ping-modal-status").css("color","red"),e.$(".course-forum-ping-modal-status").text("Error: "+t.responseText)}),e.$(".course-forum-ping-modal-status").css("color","black"),e.$(".course-forum-ping-modal-status").text("Sending...")}});return d});