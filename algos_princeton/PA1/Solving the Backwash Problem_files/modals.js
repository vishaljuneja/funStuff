(function(){var t=function(t,i,o,e){var s=0,a=1,n={defaults:{"bind.open":"click","bind.close":"click","bind.action":"click","bind.esc":!0,"attribute.open":"data-modal","attribute.close":"data-modal-close","attribute.iframe":"data-modal-iframe","attribute.action":"data-modal-action","animate.modal.open":null,"animate.modal.close":null,"animate.modal.duration":250,"animate.overlay.open":null,"animate.overlay.close":null,"animate.overlay.duration":250,"overlay.show":!0,"overlay.class":"overlay","overlay.close":!0,"close.selector":!1,"close.esc":!0,"z.index":9999,"position.top":"50%","position.left":"50%",position:"fixed","iframe.autoclose":!0},$overlay:null,count:0,prevScroll:null,prevModal:null,getModal:function(i,o){var e=t(i).data("modal.me");return e&&e.constructor==r.prototype.constructor?o?e.customize(o):e:null},makeModal:function(i,o){var e=t(i),s=n.getModal(e);return s||(s=new r(e,o),e.data("modal.me",s)),s},setOverlayHeight:function(){t(window).height()<t(document).height()?n.$overlay.css({height:t(document).height()+"px"}):n.$overlay.css({height:"100%"})},observeKeyPress:function(t){(27==t.keyCode||27==t.DOM_VK_ESCAPE&&0===t.which)&&this.options["bind.esc"]&&this.close()},actionTrigger:function(i){var o=t(i.currentTarget),e=o.attr(this.options["attribute.action"]);this.emitter.trigger("action",e,this)},open:function(){if("fixed"!=this.options.position&&(n.prevScroll={top:t(document).scrollTop(),left:t(document).scrollLeft()},window.scrollTo(0,0)),this.$iframe){var i=this.options["iframe.url"]||t(this.anchor).attr(this.options["attribute.iframe"]);this.$iframe.attr("src",i),this.$iframe.focus()}else this.$el.focus();this.state=a,this.$el.on(this.options["bind.action"],"["+this.options["attribute.action"]+"]",o.bind(n.actionTrigger,this)),this.emitter.trigger("open")},close:function(){var t=this.$el.find("iframe");this.$el.off(".modal").hide(),this.options["iframe.autoclose"]&&t.size()&&t.attr({src:"about:blank"}),n.prevScroll&&(window.scrollTo(n.prevScroll.left,n.prevScroll.top),n.prevScroll=null),this.anchor=null,this.$parent.append(this.$el),this.state=s,this.emitter.trigger("close")}},r=function(o,e){this.$el=t(o),this.state=s,this.$parent=this.$el.parent(),this.customize(e),this.emitter=i.emitter(this)};r.prototype.customize=function(t){return this.options=o.extend({},e.parse(this.$el,n.defaults,"data-modal-"),t),this},r.prototype.open=function(){var i,e=this;return this.anchor&&(i=t(this.anchor).attr(this.options["attribute.iframe"])),this.options["iframe.url"]&&(i=this.options["iframe.url"]),i&&(this.$iframe=this.$el.find("iframe"),/^https?:\/\/|^\/|^\.\.\//.test(i)&&(this.$iframe.size()&&this.$iframe.attr("src")==i||(this.$iframe.attr("src","about:blank").remove(),this.$iframe=t("<iframe>").css({height:"100%",width:"100%"}).attr({scrolling:"no",frameborder:0}),this.$el.append(this.$iframe),this.state!=s&&this.$iframe.attr("src",i)))),this.state==s?(this.options["overlay.show"]&&(n.$overlay&&"none"!=n.$overlay.css("display")&&n.$overlay.hasClass(this.options["overlay.class"])?this.$overlay=n.$overlay:(n.$overlay&&n.$overlay.off(".modal").hide().remove(),this.$overlay=n.$overlay=t("<div>").addClass(this.options["overlay.class"]).hide(),this.$overlay.css({position:"fixed",width:"100%",top:0,left:0,right:0,bottom:0,zIndex:this.options["z.index"]++}),t("body").append(this.$overlay)),n.setOverlayHeight(),this.reposition(),this.options["animate.overlay.open"]?this.$overlay.animate(this.options["animate.overlay.open"],{duration:this.options["animate.overlay.duration"]}):this.$overlay.show(),n.count++,this.$overlay.data("modal",this)),this.emitter.trigger("opening"),("fixed"!=this.options.position||0===this.$el.closest("html").length)&&this.$el.appendTo("body"),this.reposition(),this.$el.show(),this.options["animate.modal.open"]?this.$el.animate(this.options["animate.modal.open"],{duration:this.options["animate.modal.duration"],complete:function(){n.open.call(e)}}):n.open.call(this),t(window).on("resize.modal",o.bind(n.setOverlayHeight,e)).on("resize.modal",o.bind(e.reposition,e)).on("scroll.modal",o.bind(e.reposition,e)).on("keyup.modal",o.bind(n.observeKeyPress,e)),this.options["overlay.close"]&&this.$overlay.on(this.options["bind.close"]+".modal",function(){e.close()}),this.options["attribute.close"]&&this.$el.on(this.options["bind.close"]+".modal","["+this.options["attribute.close"]+"]",function(){"disabled"!=e.$el.attr("disabled")&&e.close()}),this):void 0},r.prototype.reposition=function(){var t=this.options["position.left"],i=this.options["position.top"];return t&&this.$el.css({position:this.options.position,left:t,marginLeft:/%/.test(t)?-1*(this.$el.outerWidth()/2):0,zIndex:this.options["z.index"]++}),i&&this.$el.css({position:this.options.position,top:i,marginTop:/%/.test(i)?-1*(this.$el.outerHeight()/2):0,zIndex:this.options["z.index"]++}),this},r.prototype.close=function(){var i=this;if(this.state==a)return this.$el.off(".modal"),t(window).off(".modal"),this.emitter.trigger("closing"),this.options["animate.modal.close"]?this.$el.animate(this.options["animate.modal.close"],{duration:this.options["animate.modal.duration"],complete:function(){n.close.call(i)}}):n.close.call(this),0===--n.count&&this.options["overlay.show"]&&this.$overlay&&(this.$overlay.off(".modal"),this.options["animate.overlay.close"]?this.$overlay.animate(this.options["animate.overlay.close"],{duration:this.options["animate.overlay.duration"],complete:function(){this.$overlay.hide().remove()}}):this.$overlay.hide().remove()),this};var l=function(){return n.getModal.apply(null,arguments)||n.makeModal.apply(this,arguments)};return l.start=function(i,s){var a=t(i),r=o.extend({},n.defaults,s);a.data("modals-initialized")||(a.data("modals-initialized",1),a.on(r["bind.open"]+".modal","["+r["attribute.open"]+"]",function(i){var s=t(this),l=s.attr(r["attribute.open"]),h=a.find(l);r=o.extend({},r,e.parse(h,n.defaults,"data-modal-"));var d=n.getModal(h,r)||n.makeModal(h,r);!/^https?:\/\/|^\/|^\.\.\//.test(s.attr("href"))||i.ctrlKey||i.metaKey||i.preventDefault(),d.anchor=this,n.prevModal=h[0],d.open()}))},l.stop=function(i){var o=t(i);o.unbind(".modal"),o.data("modals-initialized",0),n.prevModal&&r(n.prevModal).close()},l.start("body"),l};"function"==typeof define&&define.amd?define(["jquery","js/lib/lucid","underscore","js/lib/data.attributes"],function(i,o,e,s){return t(i,o,e,s)}):"undefined"!=typeof window&&"undefined"==typeof ender&&(window.Modal=t(window.$,window.LucidJS,window._,window.DataAttributes))})();