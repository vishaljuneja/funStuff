define(["backbone","jquery","underscore","js/lib/moment","js/lib/util","pages/forum/app","pages/forum/views/EntryView.html","pages/forum/views/EntryBylineView.html","pages/forum/views/EntryEditView.html","pages/forum/views/EntryReportView.html","pages/forum/views/EditorUtil","js/lib/popups","js/lib/modals","js/lib/coursera.mathjax","js/lib/badgeville"],function(e,t,o,r,n,i,s,a,u,c,l,d,p,g,h){var m="Forum Entry",f=e.View.extend({template:s,tagName:"li",events:{"click .course-forum-post-admin-details-link":"onAdminDetailsClick","click .course-forum-post-action-link":"onEntryActionClick","click .course-forum-post-edit-link":"onEntryEditClick","click .course-forum-post-controls-toggle":"onGearClick","click .course-forum-post-edit-form button.course-forum-post-edit-save":"onEntryEditSave","click .course-forum-post-vote-button":"onVoteClick","click a.course-forum-post-edit-cancel":"onEntryEditCancel","click .course-forum-post-controls-report":"onReportClick","click .course-forum-report-modal button":"onReportSave"},initialize:function(){this.model.bind("sync",this.render,this),this.model.bind("change",this.renderBylineMaybe,this),this.model.bind("error",this.renderError,this)},render:function(){var e=this;return e.renderEntry(),e.model.isNew()?e.renderEditMode():g.render(e.el),e},renderEntry:function(){var e=this;e.$el.html(e.template({entry:this.model,user:i.user})),e.renderByline(),e.$viewContainer=e.$(".course-forum-post-view-container");var t=this.model.changedAttributes();return t&&(t[this.model.textProp]?e.$(".course-forum-post-text").animate({"margin-left":"-=5"},100).animate({"margin-left":"+=5"},100):t.votes&&e.$(".course-forum-post-vote-controls").animate({"margin-left":"-=5"},100).animate({"margin-left":"+=5"},100)),e.model.get("_viewer_can_vote")||e.$(".course-forum-post-vote-button").addClass("course-forum-post-vote-disabled"),e},renderBylineMaybe:function(){var e=this.model.changedAttributes();e&&e._user_profile&&this.renderByline()},renderByline:function(){var e=this;if(this.$(".course-forum-post-byline").html(a({entry:this.model,user:i.user,config:i.config})),n.prettifyTime(this.$(".course-forum-post-byline time")),h.isEnabled()&&(e.setupBadgevilleByline=!1,e.model.get("user_id")&&h.getUserBucket(i.user.get("id")).thread_byline)){var r=o.throttle(o.bind(e.renderBadgevilleBylineMaybe,e),300);t(window).on("scroll.badgevillebylines"+this.model.get("id"),r),window.setTimeout(function(){e.renderBadgevilleBylineMaybe()},1),window.setTimeout(function(){e.renderBadgevilleBylineMaybe()},500)}},renderBadgevilleBylineMaybe:function(){if(h.isAPILoaded()){var e=this,o=e.$(".course-forum-profile-badgeville");!e.setupBadgevilleByline&&e.$el.is(":visible")&&n.inView(o,200)&&(h.setupByline(e.model.get("user_id"),o),t(window).off("scroll.badgevillebylines"+e.model.get("id")),e.setupBadgevilleByline=!0)}},renderError:function(e,o){this.$(".course-forum-entry-error").remove();var r=t("<div>");r.append(o.responseText).addClass("alert alert-error course-forum-entry-error"),this.$el.append(r)},onGearClick:function(){i.multitracker.push([m,"Controls Open"])},onAdminDetailsClick:function(){this.$(".course-forum-post-admin-container").show(),i.multitracker.push([m,"Admin Details"])},onEntryEditCancel:function(){this.$editContainer.hide(),this.model.isNew()||this.$viewContainer.show()},onEntryEditClick:function(){var e=this;e.renderEditMode(),i.multitracker.push([m,"Edit"])},renderEditMode:function(){var e=this;if(!e.$editContainer||e.$editContainer&&!e.$editContainer.parent().length){e.$el.append(u({entry:this.model})),e.$editContainer=e.$(".course-forum-post-edit-container"),e.$viewContainer.hide(),e.$editContainer.show();var t=l.makeEditor(e.$editContainer.find("form"));"comment"==e.model.entryType&&t.on("load",function(){t.composer&&t.composer.element.focus()})}else e.$viewContainer.hide(),e.$editContainer.show();e.$editContainer.find(".course-forum-post-edit-save").removeAttr("disabled")},onEntryEditSave:function(e){var t=this;e.preventDefault();var o=l.getPropsFromForm(t.$editContainer.find("form")),r=t.model.isNew();return t.model.update(o,{message:{waiting:"Saving...",success:"Saved!"}}).done(function(){r&&1!=o.anonymous&&h.credit({verb:"created-entry",thread:t.model.get("thread").get("id"),entry:t.model.get("id"),week:h.getWeek()})}),t.$editContainer.find(".course-forum-post-edit-save").attr("disabled","disabled"),i.multitracker.push([m,"Edit Save"]),!1},onEntryActionClick:function(e){var o=t(e.target),r=o.attr("data-property"),n=o.attr("data-value"),s={};s[r]=n,this.model.update(s,{message:{waiting:"Processing...",success:"Processed!"}}),i.multitracker.push([m,"Action "+r+" "+n])},onVoteClick:function(e){var o=this;e.preventDefault(),e.stopPropagation();var r=t(e.target).closest(".course-forum-post-vote-button");if(!r.hasClass("course-forum-post-vote-disabled")){var n=o.model.get("_viewer_voted"),s=r.attr("data-direction-value");return i.api.post(this.model.votesUrl(),{data:{direction:s},message:{waiting:"Recording vote...",success:"Recorded vote!"}}).done(function(e){if(o.model.set(e),o.renderEntry(),h.isEnabled()&&!n&&(h.credit({verb:"voted",direction:s,thread:o.model.get("thread").get("id"),week:h.getWeek()}),1==s)){var t=o.model.get("thread").get("id"),r=o.model.get("thread").get("id")+o.model.entryType+o.model.get("id");h.creditOther(o.model.get("user_id"),{verb:"got-upvote-on-entry",thread:t,entry:r,num_votes:o.model.get("votes"),entry_type:o.model.get("original")?"original":"reply",week:h.getWeek()}),o.model.get("votes")>=3&&h.creditOther(o.model.get("user_id"),{verb:"got-3-upvotes-on-entry",thread:t,entry:r,num_votes:o.model.get("votes"),entry_type:o.model.get("original")?"original":"reply",week:h.getWeek()})}}),!1}},onReportClick:function(){var e=this;e.$el.append(c());var t=new p(e.$(".course-forum-report-modal"));t.open(),e.$(".course-forum-report-modal textarea").focus()},onReportSave:function(){var e=this,t=e.$(".course-forum-report-modal textarea").val();i.api.post(this.model.reportsUrl(),{data:{description:t},message:{waiting:"Sending report...",success:"Sent!"}}).done(function(){})}});return f});