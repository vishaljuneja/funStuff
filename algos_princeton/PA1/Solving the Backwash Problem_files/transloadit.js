(function(){var e=function(e,t,n,r,o){var i=function(t,n){var r=this;this.modal=t,this.$element=this.modal.$el.find(".transloadit-uploader"),this.$preview=this.$element.find(".uploader-preview"),this.$button=this.$element.find(".uploader-button"),this.$progress=this.$element.find(".uploader-progress"),this.$input=this.$element.find(".uploader-input-url");var o={max_size:n["transloadit.max_size"]||1048576,auth:{key:n["transloadit.key"]},template_id:n["transloadit.template"],steps:{store:{}}};this.$element.transloadit({params:o,wait:!0,modal:!1,autoSubmit:!1,processZeroFiles:!1,onPick:function(){r.$element.find(".help-inline.errror").remove(),r.$progress.show(),r.$progress.find(".bar").css("width","0%")},onStart:function(){r.$button.hide()},onProgress:function(e,t){var n=(100*(e/t)).toFixed(2);n=Math.min(95,n),isNaN(n)||r.$progress.find(".bar").css("width",n+"%")},onSuccess:function(t){function n(e){return e.replace(/^http:\/\//i,"https://")}function o(e){var r=t.results[e][0];return r.value=n(r.url),"image"==r.type&&(r.image=r.value),r}r.$progress.fadeOut();var i,s=0;e.each(t.results,function(e){s++,i=e}),t.results[":original"]&&s>1&&(i=":original");var a=o(i);r.$input.val(a.value).trigger("change"),r.updatePreview(!0),r.$preview.show(),r.$element.find('input[name="uploader_file_input"]').val("")},onError:function(t){var n=e('<span class="help-inline error"></span>').append(t);r.$button.show(),r.$element.find(".uploader-side").append(n),r.$element.find('input[name="uploader_file_input"]').val("")}}),this.updatePreview()};return i.prototype.updatePreview=function(){var e=this;if(e.$width=e.$element.find(".uploader-input-width"),e.$height=e.$element.find(".uploader-input-height"),this.$input.val()){var t=this.$preview.find("img");t.attr("src",this.$input.val()).show(),this.$preview.show(),t.on("load",function(){e.$width.val(t.width()),e.$height.val(t.height()),e.modal.reposition(),e.$width.on("keyup",function(){var n=Math.round(t.height()/t.width()*e.$width.val());e.$height.val(n)}),e.$height.on("keyup",function(){var n=Math.round(t.width()/t.height()*e.$height.val());e.$width.val(n)})})}else this.$preview.hide(),this.modal.reposition()},i.prototype.reset=function(){this.$input.val(""),this.updatePreview(),this.$button.show()},t.defaults=e.extend(t.defaults,{"toolbar.image":!1,"transloadit.key":"","transloadit.template":""}),t.plugin("transloadit",function(s,a,c,l){if(l["toolbar.image"]){var u=e(r({prefix:l["prefix.css"]}));t.insertIntoLeftToolbar(a,u,7),a.find("."+l["prefix.css"]+"-toolbar-modals").append(o({prefix:l["prefix.css"]}));var d,h=a.find("[data-wysihtml5-modal-image]"),p=h.find("[type=submit]"),f=n(h),g=new i(f,l),m=h.find("[name=result]");f.on("close",function(){s.currentView.element.focus()}),m.bind("change input textinput blur",function(){m.val().indexOf("http")>-1&&p.removeAttr("disabled").show()}),h.find("form").on("submit",function(e){e.preventDefault(),e.stopPropagation(),s.currentView.element.focus(),(void 0!==d||null!==d)&&(s.composer.selection.setBookmark(d),d=null);var t=m.val();if(t){var n=h.find(".uploader-input-width").val(),r=h.find(".uploader-input-height").val(),o=r||n?"width:"+n+"px;height:"+r+"px;":"";s.composer.commands.exec("insertImage",{src:t,style:o}),s.fire("change").fire("change:composer")}}),a.find("[data-wysihtml5-custom-command=image]").on("click",function(){e(this).hasClass("wysihtml5-command-active")||a.hasClass("wysihtml5-commands-disabled")||(d=s.composer&&s.composer.selection.getBookmark(),g.reset(),p.attr("disabled","").hide(),f.open())})}}),t};"function"==typeof define&&define.amd?define(["jquery","bundles/wysihtml5/editor","js/lib/modals","bundles/wysihtml5/toolbar-transloadit.html","bundles/wysihtml5/toolbar-modal-transloadit.html","js/lib/jquery.transloadit2"],function(t,n,r,o,i,s){return e(t,n,r,o,i,s)}):e(window.$,window.wysiEditor,window.Modal,window.jade.templates["bundles.wysihtml5.toolbar-transloadit"],window.jade.templates["bundles.wysihtml5.toolbar-modal-transloadit"])})(window);